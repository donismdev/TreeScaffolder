@@@FILE_BEGIN {{Root}}/FrontendUI/FrontendUI.Build.cs
using UnrealBuildTool;

public class FrontendUI : ModuleRules
{
	public FrontendUI(ReadOnlyTargetRules Target) : base(Target)
	{
		PCHUsage = PCHUsageMode.UseExplicitOrSharedPCHs;

		PublicDependencyModuleNames.AddRange(new string[]
		{
			"Core",
			"CoreUObject",
			"Engine",
		});

		PrivateDependencyModuleNames.AddRange(new string[]
		{
			"UMG",
			"Slate",
			"SlateCore",
		});
	}
}

@@@FILE_END


@@@FILE_BEGIN {{Root}}/FrontendUI/Public/UI/MainMenuWidget.h
#pragma once

#include "CoreMinimal.h"
#include "Blueprint/UserWidget.h"
#include "MainMenuWidget.generated.h"

DECLARE_MULTICAST_DELEGATE_OneParam(FOnModeSelectedNative, FName);

class UButton;
class UVerticalBox;

UCLASS()
class UMainMenuWidget final : public UUserWidget
{
	GENERATED_BODY()

public:
	FOnModeSelectedNative OnModeSelected;

protected:
	virtual void NativeConstruct() override;

private:
	UPROPERTY()
	TObjectPtr<UVerticalBox> RootBox;

	UPROPERTY()
	TObjectPtr<UButton> MercenaryButton;

private:
	UFUNCTION()
	void HandleMercenaryClicked();
};

@@@FILE_END


@@@FILE_BEGIN {{Root}}/FrontendUI/Private/UI/MainMenuWidget.cpp
#include "UI/MainMenuWidget.h"

#include "Blueprint/WidgetTree.h"
#include "Components/Button.h"
#include "Components/TextBlock.h"
#include "Components/VerticalBox.h"

void UMainMenuWidget::NativeConstruct()
{
	Super::NativeConstruct();

	if (WidgetTree == nullptr)
	{
		return;
	}

	RootBox = WidgetTree->ConstructWidget<UVerticalBox>(UVerticalBox::StaticClass());
	if (RootBox == nullptr)
	{
		return;
	}

	MercenaryButton = WidgetTree->ConstructWidget<UButton>(UButton::StaticClass());
	if (MercenaryButton == nullptr)
	{
		return;
	}

	UTextBlock* ButtonTextPtr = WidgetTree->ConstructWidget<UTextBlock>(UTextBlock::StaticClass());
	if (ButtonTextPtr != nullptr)
	{
		ButtonTextPtr->SetText(FText::FromString(TEXT("Mercenary")));
		MercenaryButton->AddChild(ButtonTextPtr);
	}

	RootBox->AddChild(MercenaryButton);
	MercenaryButton->OnClicked.AddDynamic(this, &UMainMenuWidget::HandleMercenaryClicked);

	WidgetTree->RootWidget = RootBox;
}

void UMainMenuWidget::HandleMercenaryClicked()
{
	OnModeSelected.Broadcast(FName(TEXT("Mercenary")));
}

@@@FILE_END


@@@FILE_BEGIN {{Root}}/FrontendEntry/FrontendEntry.Build.cs
using UnrealBuildTool;

public class FrontendEntry : ModuleRules
{
	public FrontendEntry(ReadOnlyTargetRules Target) : base(Target)
	{
		PCHUsage = PCHUsageMode.UseExplicitOrSharedPCHs;

		PublicDependencyModuleNames.AddRange(new string[]
		{
			"Core",
			"CoreUObject",
			"Engine",
		});

		PrivateDependencyModuleNames.AddRange(new string[]
		{
			"FrontendUI",
			"GameplayCore",
			"CDR",

			"UMG",
			"Slate",
			"SlateCore",
		});
	}
}

@@@FILE_END


@@@FILE_BEGIN {{Root}}/FrontendEntry/Public/Bootstrap/FrontendEntryGameMode.h
#pragma once

#include "CoreMinimal.h"
#include "GameFramework/GameModeBase.h"
#include "FrontendEntryGameMode.generated.h"

class UMainMenuWidget;

UCLASS()
class AFrontendEntryGameMode final : public AGameModeBase
{
	GENERATED_BODY()

public:
	AFrontendEntryGameMode();

	virtual void BeginPlay() override;

private:
	UPROPERTY()
	TObjectPtr<UMainMenuWidget> MainMenuWidget;

private:
	void HandleModeSelected(const FName SelectedModeIdValue);

private:
	static bool TryBuildStartContextFromModeId(const FName SelectedModeIdValue, struct FCDRStartContext& OutContextValue);
};

@@@FILE_END


@@@FILE_BEGIN {{Root}}/FrontendEntry/Private/Bootstrap/FrontendEntryGameMode.cpp
#include "Bootstrap/FrontendEntryGameMode.h"

#include "Bootstrap/FrontendEntryPlayerController.h"

#include "UI/MainMenuWidget.h"

#include "CDRGameInstance.h"
#include "Flow/CDRStartContext.h"
#include "Presentation/IPuzzlePresentation.h"

#include "Engine/World.h"
#include "GameFramework/PlayerController.h"

AFrontendEntryGameMode::AFrontendEntryGameMode()
{
	PlayerControllerClass = AFrontendEntryPlayerController::StaticClass();
}

void AFrontendEntryGameMode::BeginPlay()
{
	Super::BeginPlay();

	UWorld* WorldPtr = GetWorld();
	if (WorldPtr == nullptr)
	{
		return;
	}

	APlayerController* PlayerControllerPtr = WorldPtr->GetFirstPlayerController();
	if (PlayerControllerPtr == nullptr)
	{
		return;
	}

	MainMenuWidget = CreateWidget<UMainMenuWidget>(PlayerControllerPtr, UMainMenuWidget::StaticClass());
	if (MainMenuWidget == nullptr)
	{
		return;
	}

	MainMenuWidget->OnModeSelected.AddUObject(this, &AFrontendEntryGameMode::HandleModeSelected);
	MainMenuWidget->AddToViewport(0);

	PlayerControllerPtr->SetInputMode(FInputModeUIOnly());
	PlayerControllerPtr->bShowMouseCursor = true;
}

void AFrontendEntryGameMode::HandleModeSelected(const FName SelectedModeIdValue)
{
	UWorld* WorldPtr = GetWorld();
	if (WorldPtr == nullptr)
	{
		return;
	}

	UCDRGameInstance* GameInstancePtr = Cast<UCDRGameInstance>(WorldPtr->GetGameInstance());
	if (GameInstancePtr == nullptr)
	{
		return;
	}

	FCDRStartContext ContextValue;
	if (TryBuildStartContextFromModeId(SelectedModeIdValue, ContextValue) == false)
	{
		return;
	}

	const bool bRequested = GameInstancePtr->RequestStartGame(ContextValue);
	if (bRequested == false)
	{
		return;
	}
}

bool AFrontendEntryGameMode::TryBuildStartContextFromModeId(const FName SelectedModeIdValue, FCDRStartContext& OutContextValue)
{
	OutContextValue.Reset();

	if (SelectedModeIdValue == FName(TEXT("Mercenary")))
	{
		OutContextValue.PresentationType = EPuzzlePresentationType::Mercenary;
		OutContextValue.Seed = 0;
		return true;
	}

	return false;
}

@@@FILE_END


@@@FILE_BEGIN {{Root}}/FrontendEntry/Public/Bootstrap/FrontendEntryPlayerController.h
#pragma once

#include "CoreMinimal.h"
#include "GameFramework/PlayerController.h"
#include "FrontendEntryPlayerController.generated.h"

UCLASS()
class AFrontendEntryPlayerController final : public APlayerController
{
	GENERATED_BODY()

public:
	AFrontendEntryPlayerController();
};

@@@FILE_END


@@@FILE_BEGIN {{Root}}/FrontendEntry/Private/Bootstrap/FrontendEntryPlayerController.cpp
#include "Bootstrap/FrontendEntryPlayerController.h"

AFrontendEntryPlayerController::AFrontendEntryPlayerController()
{
	bShowMouseCursor = true;
}

@@@FILE_END


@@@FILE_BEGIN {{Root}}/FrontendEntry/Private/FrontendEntryModule.cpp
#include "Modules/ModuleManager.h"

class FFrontendEntryModule final : public IModuleInterface
{
public:
	virtual void StartupModule() override
	{
	}

	virtual void ShutdownModule() override
	{
	}
};

IMPLEMENT_MODULE(FFrontendEntryModule, FrontendEntry)

@@@FILE_END

